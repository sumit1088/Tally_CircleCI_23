version: 2.1

executors:
  docker-executor:
    docker:
      - image: cimg/python:3.11
    working_directory: ~/workspace

jobs:
  checkout_code:
    executor: docker-executor
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - persist_to_workspace:
          root: ~/workspace
          paths:
            - .

  build_containers:
    executor: docker-executor
    steps:
      - attach_workspace:
          at: ~/workspace
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Build FastAPI and RQ Worker Containers
          command: docker compose build pharmaseek-fastapi rq-worker

  run_fastapi_check:
    executor: docker-executor
    steps:
      - attach_workspace:
          at: ~/workspace
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Start FastAPI in background
          command: |
            docker compose up -d pharmaseek-fastapi redis db
            sleep 20
      - run:
          name: Run smoke test from inside Docker network
          command: |
            docker run --rm --network workspace_default curlimages/curl:7.88.1 \
              curl -f http://pharmaseek-fastapi:8000/docs
      - run:
          name: Shut down containers
          command: docker compose down

workflows:
  version: 2
  build_and_validate:
    jobs:
      - checkout_code
      - build_containers:
          requires:
            - checkout_code
      - run_fastapi_check:
          requires:
            - build_containers
